[%# 1.0@bugzilla.org %]
[%# The contents of this file are subject to the Mozilla Public
  # License Version 1.1 (the "License"); you may not use this file
  # except in compliance with the License. You may obtain a copy of
  # the License at http://www.mozilla.org/MPL/
  #
  # Software distributed under the License is distributed on an "AS
  # IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
  # implied. See the License for the specific language governing
  # rights and limitations under the License.
  #
  # The Original Code is the Bugzilla Bug Tracking System.
  #
  # The Initial Developer of the Original Code is Netscape Communications
  # Corporation. Portions created by Netscape are
  # Copyright (C) 1998 Netscape Communications Corporation. All
  # Rights Reserved.
  #
  # Contributor(s): Gervase Markham <gerv@gerv.net>
  #                 Vaskin Kissoyan <vkissoyan@yahoo.com>
  #                 Max Kanat-Alexander <mkanat@bugzilla.org>
  #                 Frédéric Buclin <LpSolit@gmail.com>
  #                 Olav Vitters <olav@bkor.dhs.org>
  #%]

[% PROCESS global/variables.none.tmpl %]

[% PROCESS "global/field-descs.none.tmpl" %]

[% PROCESS bug/time.html.tmpl %]

  <script type="text/javascript">
  <!--

  /* Adds the reply text to the `comment' textarea */
  function replyToComment(id) {
      /* pre id="comment_name_N" */
      var text_elem = document.getElementById('comment_text_'+id);
      var text = getText(text_elem);

      /* make sure we split on all newlines -- IE or Moz use \r and \n
       * respectively.
       */
      text = text.split(/\r|\n/);

      var replytext = "";
      for (var i=0; i < text.length; i++) {
          replytext += "> " + text[i] + "\n"; 
      }

      replytext = "(In reply to comment #" + id + ")\n" + replytext + "\n";

    [% IF Param("insidergroup") && user.in_group(Param("insidergroup")) %]
      if (document.getElementById('isprivate-'+id).checked) {
          document.getElementById('newcommentprivacy').checked = 'checked';
      }
    [% END %]

      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      textarea.value += replytext;

      textarea.focus();
  }

  if (typeof Node == 'undefined') {
      /* MSIE doesn't define Node, so provide a compatibility object */
      window.Node = {
          TEXT_NODE: 3,
          ENTITY_REFERENCE_NODE: 5
      };
  }

  /* Concatenates all text from element's childNodes. This is used
   * instead of innerHTML because we want the actual text (and
   * innerText is non-standard).
   */
  function getText(element) {
      var child, text = "";
      for (var i=0; i < element.childNodes.length; i++) {
          child = element.childNodes[i];
          var type = child.nodeType;
          if (type == Node.TEXT_NODE || type == Node.ENTITY_REFERENCE_NODE) {
              text += child.nodeValue;
          } else {
              /* recurse into nodes of other types */
              text += getText(child);
          }
      }
      return text;
  }

[% IF user.in_group(Param('timetrackinggroup')) %]
  var fRemainingTime = [% bug.remaining_time %]; // holds the original value
  function adjustRemainingTime() {
      // subtracts time spent from remaining time
      var new_time;

      // prevent negative values if work_time > fRemainingTime
      new_time =
          Math.max(fRemainingTime - document.changeform.work_time.value, 0.0);
      // get upto 2 decimal places
      document.changeform.remaining_time.value =
          Math.round(new_time * 100)/100;
  }

  function updateRemainingTime() {
      // if the remaining time is changed manually, update fRemainingTime
      fRemainingTime = document.changeform.remaining_time.value;
  }

[% END %]

  function updateCommentTagControl(checkbox, form) {
      if (checkbox.checked) {
          form.comment.className='bz_private';
      } else {
          form.comment.className='';
      }
  }

  function toggleField(field) {
    var element_style = document.getElementById(field).style;
    if (element_style.display == "none") {
        element_style.display = "";
    } else {
        element_style.display = "none";
    }
  }

  //-->
  </script>

<form name="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="[% bug.delta_ts %]">
  <input type="hidden" name="longdesclength" value="[% bug.longdescs.size %]">
  <input type="hidden" name="id" value="[% bug.bug_id %]">

  <h3 style="background-color: #D0D0D0; -moz-border-radius: 0.5em; padding: 0.3em; margin: 8px 0px;"><a href="show_bug.cgi?id=[% bug.bug_id %]">[% terms.Bug %] [%+ bug.bug_id %]</a>[% " ($bug.alias)" FILTER html IF Param("usebugaliases") && bug.alias %] &ndash; [% bug.short_desc FILTER quoteUrls(bug.bug_id) %] [%+ IF user.id %]<small>(<a href="javascript:toggleField('summary');">edit</a>)</small>[% END %]</h3>

  <div id="summary" style="display: none;">
    <p><label for="short_desc" accesskey="s"><b><u>S</u>ummary</b></label>:
       [% PROCESS input inputname => "short_desc" size => "60" notable => 1
                        maxlength => 255 spellcheck => "true" %]
    [% IF Param("usebugaliases") %]
      <label for="alias" title="a name for the [% terms.bug %] that can be used in place of its ID number, f.e. when adding it to a list of dependencies"><b>Alias</b></label>:
         [% PROCESS input inputname => "alias" size => "20" notable => 1 maxlength => "20" %]
    [% END %]
  </div>

  [%# That's the main table, which contains all editable fields. %]
  <table border="0" cellspacing="0" cellpadding="0">
    <tbody>
      <tr>
         <td colspan="3" valign="top">
           <table>
              <tbody>
                [%# *** Status and resolution, severity, keywords, whiteboard, URL *** %]
                [% PROCESS left_section1 %]
                <tr><td colspan="3">&nbsp;</td></tr>
                [%# *** Product, component, version, hardware, OS *** %]
                [% PROCESS left_section2 %]
                <tr><td colspan="3">&nbsp;</td></tr>
                [%# *** Assignee, QA contact, priority, milestone *** %]
                [% PROCESS left_section3 %]
                <tr><td colspan="3">&nbsp;</td></tr>
                [%# *** Dependencies *** %]
                <tr>
                  [% PROCESS dependencies
                             dep = { title => "Depends&nbsp;on", fieldname => "dependson" } %]
                </tr>

                <tr>
                  [% PROCESS dependencies accesskey = "b"
                             dep = { title => "<u>B</u>locks", fieldname => "blocked" } %]
                </tr>

                <tr>
                  <td>&nbsp;</td>
                  <td colspan="2">
                    <a href="showdependencytree.cgi?id=[% bug.bug_id %]&amp;hide_resolved=1">Show
                       dependency tree</a>

                    [% IF Param('webdotbase') %]
                      - <a href="showdependencygraph.cgi?id=[% bug.bug_id %]">Show
                           dependency graph</a>
                    [% END %]
                  </td>
                </tr>
              </tbody>
            </table>
          </td>

         <td style="width: 35px;"></td>
         <td align="right" valign="top">

         <table>
           <tbody>
             [%# *** Reporter, last modified, votes, CC list *** %]
             [% PROCESS right_section1 %]

             [%# *** Custom Fields *** %]
             [% USE Bugzilla %]
             [% fields = Bugzilla.get_fields({ obsolete => 0, custom => 1 }) %]
             [% IF fields %]
               <tr><td colspan="2">&nbsp;</td></tr>
               [% FOREACH field = fields %]
                 <tr>
                   [% PROCESS bug/field.html.tmpl value=bug.${field.name}
                                                  editable = bug.check_can_change_field(field.name, 0, 1)
                                                  value_span = 2 %]
                 </tr>
               [% END %]
             [% END %]

             [%# *** Flags *** %]
             [% show_bug_flags = 0 %]
             [% FOREACH type = bug.flag_types %]
               [% IF (type.flags && type.flags.size > 0) || (user.id && type.is_active) %]
                 [% show_bug_flags = 1 %]
                 [% LAST %]
               [% END %]
             [% END %]
             [% IF show_bug_flags %]
               <tr><td colspan="2">&nbsp;</td></tr>
               [% PROCESS flags %]
             [% END %]

           </tbody>
         </table>
         </td>
       </tr>
    </tbody>
  </table>

  <hr>

  [% IF user.in_group(Param('timetrackinggroup')) %]
    <br>
    <table cellspacing="0" cellpadding="4" border="1">
      <tr>
        <th align="center" bgcolor="#cccccc">
          <label for="estimated_time">Orig. Est.</label>
        </th>
        <th align="center" bgcolor="#cccccc">
          Current Est.
        </th>
        <th align="center" bgcolor="#cccccc">
          <label for="work_time">Hours Worked</label>
        </th>
        <th align="center" bgcolor="#cccccc">
          <label for="remaining_time">Hours Left</label>
        </th>
        <th align="center" bgcolor="#cccccc">
          %Complete
        </th>
        <th align="center" bgcolor="#cccccc">
          Gain
        </th>
        <th align="center" bgcolor="#cccccc">
          <label for="deadline">Deadline</label>
        </th>
      </tr>
      <tr>
        <td align="center">
          <input name="estimated_time" id="estimated_time"
                 value="[% PROCESS formattimeunit
                                   time_unit=bug.estimated_time %]"
                 size="6" maxlength="6">
        </td>
        <td align="center">
          [% PROCESS formattimeunit
                     time_unit=(bug.actual_time + bug.remaining_time) %]
        </td>
        <td align="center">
          [% PROCESS formattimeunit time_unit=bug.actual_time %] +
          <input name="work_time" id="work_time"
                 value="0" size="3" maxlength="6"
                 onchange="adjustRemainingTime();">
        </td>
        <td align="center">
          <input name="remaining_time" id="remaining_time"
                 value="[% PROCESS formattimeunit
                                   time_unit=bug.remaining_time %]"
                 size="6" maxlength="6" onchange="updateRemainingTime();">
        </td>
        <td align="center">
          [% PROCESS calculatepercentage act=bug.actual_time
                                         rem=bug.remaining_time %]
        </td>
        <td align="center">
          [% PROCESS formattimeunit time_unit=bug.estimated_time - (bug.actual_time + bug.remaining_time) %]
        </td>
         <td align="center">
           <input name="deadline" id="deadline" value="[% bug.deadline %]"
                  size="10" maxlength="10"><br />
           <small>(YYYY-MM-DD)</small>
        </td>        
      </tr>
      <tr>
        <td colspan="7" align="right">
          <a href="summarize_time.cgi?id=[% bug.bug_id %]&amp;do_depends=1">
          Summarize time (including time for [% terms.bugs %]
          blocking this [% terms.bug %])</a>
        </td>
      </tr>
    </table>
  [% END %]

[%# *** Attachments *** %]

  [% PROCESS attachment/list.html.tmpl
             attachments = bug.attachments
             bugid       = bug.bug_id
             num_attachment_flag_types = bug.num_attachment_flag_types
             show_attachment_flags = bug.show_attachment_flags
   %]

[% IF (NOT user.id AND user.settings.comment_box_position.default_value == 'before_comments')
   OR user.settings.comment_box_position.value == 'before_comments' %]
  [% PROCESS comment_box %]
  <br>
[% END %]

[%# *** Additional Comments *** %]

<div id="comments">
[% PROCESS bug/comments.html.tmpl
   comments = bug.longdescs
   mode = user.id ? "edit" : "show"
 %]
</div>

[% PROCESS comment_box
   IF (NOT user.id AND user.settings.comment_box_position.default_value == 'after_comments')
   OR user.settings.comment_box_position.value == 'after_comments' %]

</form>

[%############################################################################%]
[%# Block for the first section of the left column                           #%]
[%############################################################################%]

[% BLOCK left_section1 %]
  <tr>
    <td>
      <b><a href="page.cgi?id=fields.html#status">Status</a></b>:
    </td>
    <td colspan="2">
      [% status_descs.${bug.bug_status} FILTER html %] [%+ get_resolution(bug.resolution) FILTER html %]
      [% IF bug.resolution == "DUPLICATE" %]
        of [% terms.bug %] [%+ "${bug.dup_id}" FILTER bug_link(bug.dup_id) FILTER none %]
      [% END %]
    </td>
  </tr>

  <tr>
    <td>
      <label for="bug_severity"><b><a href="page.cgi?id=fields.html#bug_severity">Severity</a></b></label>:
    </td>
    [% PROCESS select selname = "bug_severity" %]
  </tr>

  [% IF use_keywords %]
    <tr>
      <td>
        <label for="keywords" accesskey="k">
          <b><a href="describekeywords.cgi"><u>K</u>eywords</a></b></label>:
      </td>
      [% PROCESS input inputname => "keywords" size => 45 colspan => 2
                       value => bug.keywords.join(', ') %]
    </tr>
  [% END %]

  [% IF Param('usestatuswhiteboard') %]
    <tr>
      <td>
        <label for="status_whiteboard" accesskey="w"><b><u>W</u>hiteboard</b></label>:
      </td>
      [% PROCESS input inputname => "status_whiteboard" size => "45" colspan => 2 %]
    </tr>
  [% END %]

  <tr>
    <td>
      <label for="bug_file_loc" accesskey="u"><b>
        [% IF bug.bug_file_loc 
           AND NOT bug.bug_file_loc.match("^(javascript|data)") %]
          <a href="[% bug.bug_file_loc FILTER html %]"><u>U</u>RL</a>
        [% ELSE %]
          [% IF bug.bug_file_loc.match("^(javascript|data)") %]
          <a href="#" onclick="document.getElementById('urlwarning').style.display='block'; return false;"><u>U</u>RL</a>
          [% ELSE %]
          <u>U</u>RL
          [% END %]
        [% END %]
      [%%]</b></label>:
[% IF bug.bug_file_loc AND bug.bug_file_loc.match("^(javascript|data)") %]
  <div id="urlwarning" style="display: none; position: fixed; top: 0; left: 0; border: 2px solid red; text-align: left; background-color: white; padding: 5px;">
  <div style="float: right; margin: 1px; border: 1px solid blue"><a href="#" onclick="document.getElementById('urlwarning').style.display='none'; return false;" style="text-decoration: none; color: blue;">&nbsp;X&nbsp;</a></div>
    <p style="margin-top: 0px;">The URL field currently contains a URL using either a <b>javascript</b> or <b>data</b> URI scheme,
    which means your Bugzilla session is vulnerable to various types of attack if you click the link.  The
    field was last changed by <b>[% bug.bug_file_loc_changer.identity FILTER html %]</b>.<p>
    <p style="margin-bottom: 0px;">Full link contents: (make sure to use the scrollbar if present)</p>
    <div style="margin: 0; padding: 5px; border: 1px dashed gray; overflow: auto; white-space: pre; font-family: monospace;">[% bug.bug_file_loc FILTER html %]</div>
    <p style="margin-bottom: 0px;">If you trust the person who last changed it, and you've examined the URL to ensure it
    won't do Bad Things, then <a href="[% bug.bug_file_loc FILTER html %]">proceed</a>.</p>
  </div>
[% END %]
    </td>
    [% PROCESS input inputname => "bug_file_loc" size => "45" colspan => 2 %]
  </tr>
[% END %]

[%############################################################################%]
[%# Block for the second section of the left column                          #%]
[%############################################################################%]

[% BLOCK left_section2 %]
  <tr>
    <td>
      <label for="product" accesskey="p"><b><u>P</u>roduct</b></label>:
    </td>
    [% PROCESS select selname => "product"
       onChange => "document.getElementById('knob-reassign-cmp').checked = true;" %]
  </tr>

  <tr>
    <td>
      <label for="component" accesskey="m"><b><a href="describecomponents.cgi?product=[% bug.product FILTER url_quote %]">Co<u>m</u>ponent</a></b></label>:
    </td>
    [% PROCESS select selname => "component"
       onChange => "document.getElementById('knob-reassign-cmp').checked = true;" %]
  </tr>

  <tr>
    <td>
      <label for="version"><b>Version</b></label>:
    </td>
    [% PROCESS select selname => "version" %]
  </tr>

  <tr>
    <td>
      <label for="rep_platform" accesskey="h"><b><u>H</u>ardware</b></label>:
    </td>
    [% PROCESS select selname => "rep_platform" %]
  </tr>

  <tr>
    <td>
      <label for="op_sys" accesskey="o"><b><u>O</u>S</b></label>:
    </td>
    [% PROCESS select selname => "op_sys" %]
  </tr>
[% END %]

[%############################################################################%]
[%# Block for the third section of the left column                           #%]
[%############################################################################%]

[% BLOCK left_section3 %]
  <tr>
    <td>
      <b><a href="page.cgi?id=fields.html#assigned_to">Assigned&nbsp;To</a></b>:
    </td>
    <td colspan="2">
      <a href="mailto:[% bug.assigned_to.email FILTER html %]"
         title="[% bug.assigned_to.identity FILTER html %]">
         [% bug.assigned_to.display_name FILTER html %]</a>
    </td>
  </tr>

  [% IF Param('useqacontact') %]
  <tr>
    <td>
      <label for="qa_contact" accesskey="q"><b><u>Q</u>A Contact</b></label>:
    </td>
    <td colspan="2">
      [% IF bug.check_can_change_field("qa_contact", 0, 1) %]
        <a href="mailto:[% bug.qa_contact.email FILTER html %]"
           title="[% bug.qa_contact.identity FILTER html %]">
          [% bug.qa_contact.display_name FILTER html %]</a>
        <small>(<a href="javascript:toggleField('qa_contact');">edit</a>)</small>
    </td>
  </tr>
  <tr>
    <td></td>
    <td colspan="2">
        [% INCLUDE global/userselect.html.tmpl
            id => "qa_contact"
            name => "qa_contact"
            value => bug.qa_contact.login
            size => 30
            emptyok => 1
            style => "display: none;"
        %]
      [% ELSE %]
        <input type="hidden" name="qa_contact" id="qa_contact"
               value="[% bug.qa_contact.login FILTER html %]">
        <a href="mailto:[% bug.qa_contact.email FILTER html %]"
           title="[% bug.qa_contact.identity FILTER html %]">
          [% bug.qa_contact.display_name FILTER html %]</a>
      [% END %]
    </td>
  </tr>
  [% END %]

  <tr>
    <td>
      <label for="priority" accesskey="i"><b><a href="page.cgi?id=fields.html#priority">Pr<u>i</u>ority</a></b></label>:
    </td>
    [% PROCESS select selname => "priority" %]
  </tr>

  [% IF Param("usetargetmilestone") && bug.target_milestone %]
    <tr>
      <td>
        <label for="target_milestone"><b>
          [% IF bug.milestoneurl %]
            <a href="[% bug.milestoneurl FILTER html %]">
          [% END %]
          Target Milestone[% "</a>" IF bug.milestoneurl %]
        [%%]</b></label>:
      </td>
      [% PROCESS select selname = "target_milestone" %]
    </tr>
  [% END %]
[% END %]

[%############################################################################%]
[%# Block for the first section of the second column                         #%]
[%############################################################################%]

[% BLOCK right_section1 %]
  <tr>
    <td>
      <b>Reported</b>:
    </td>
    <td>
      [% bug.creation_ts FILTER time %] by
      <a href="mailto:[% bug.reporter.email FILTER html %]"
         title="[% bug.reporter.identity FILTER html %]">
        [% bug.reporter.display_name FILTER truncate(33) FILTER html %]</a>
    </td>
  </tr>

  <tr>
    <td>
      <b>Modified</b>:
    </td>
    <td>
      [% bug.delta_ts FILTER time %]
      <small>(<a href="show_activity.cgi?id=[% bug.bug_id %]">View [% terms.Bug %] Activity</a>)</small>
    </td>
  </tr>

  [% IF bug.use_votes %]
  <tr>
    <td>
      <b><a href="page.cgi?id=voting.html">Votes</a></b>:
    </td>
    <td>
      [% bug.votes %]
      [%+ IF bug.votes %]<small>(<a href="votes.cgi?action=show_bug&amp;bug_id=[% bug.bug_id %]">show</a>)</small>[% END %]
      [%+ IF user.id %]<small>(<a href="votes.cgi?action=show_user&amp;bug_id=[% bug.bug_id %]#vote_[% bug.bug_id %]">vote</a>)</small>[% END %]
    </td>
  </tr>
  [% END %]

  [% IF user.id %]
    <tr>
      <td valign="top">
        <label for="newcc" accesskey="a"><b><u>A</u>dd&nbsp;CC</b></label>:
      </td>
      <td>
         [% INCLUDE global/userselect.html.tmpl
            id => "newcc"
            name => "newcc"
            value => ""
            size => 30
            multiple => 5
          %]
      </td>
    </tr>
  [% END %]

  <tr>
    [% IF bug.cc %]
      <td valign="top">
        <label for="cc"><b>CC</b></label>:
      </td>
      <td valign="top">
        <select id="cc" name="cc" multiple="multiple" size="5">
        [% FOREACH c = bug.cc %]
          <option value="[% c FILTER html %]">[% c FILTER html %]</option>
        [% END %]
        </select>
        [% IF user.id %]
          <br>
          <input type="checkbox" id="removecc" name="removecc">
          [%%]<label for="removecc">Remove selected CCs</label>
          <br>
        [% END %]
      </td>
    [% ELSE %]
      <td colspan="2"><input type="hidden" name="cc" value=""></td>
    [% END %]
  </tr>
[% END %]

[%############################################################################%]
[%# Block for flags                                                          #%]
[%############################################################################%]

[% BLOCK flags %]
  <tr>
    <td colspan="2" valign="top">
      <b>Flags</b>:
    </td>
  </tr>
  <tr>
    <td colspan="2" valign="top">
      [% IF user.id %]
        [% IF bug.flag_types.size > 0 %]
          [% PROCESS "flag/list.html.tmpl" flag_no_header = 1
                                           flag_types = bug.flag_types
                                           any_flags_requesteeble = bug.any_flags_requesteeble %]
        [% END %]
      [% ELSE %]
        [% FOREACH type = bug.flag_types %]
          [% FOREACH flag = type.flags %]
            <span title="[% flag.setter.identity FILTER html %]">[% flag.setter.nick FILTER html %]</span>:
            [%+ type.name FILTER html FILTER no_break %][% flag.status %]
            [%+ IF flag.requestee %]
              (<span title="[% flag.requestee.identity FILTER html %]">[% flag.requestee.nick FILTER html %]</span>)
            [% END %]<br>
          [% END %]
        [% END %]
      [% END %]
    </td>
  </tr>
[% END %]

[%############################################################################%]
[%# Block for dependencies                                                   #%]
[%############################################################################%]

[% BLOCK dependencies %]
  <th align="left" valign="top">
    <label for="[% dep.fieldname %]"[% " accesskey=\"$accesskey\"" IF accesskey %]>
    [% dep.title %]</label>:
  </th>
  <td>
  [% FOREACH depbug = bug.${dep.fieldname} %]
    [% depbug FILTER bug_link(depbug) FILTER none %][% " " %]
  [% END %]
  </td>
  [% IF bug.check_can_change_field(dep.fieldname, 0, 1) %]
    <td>
      <small>(<a href="javascript:toggleField('[% dep.fieldname %]');">edit</a>)</small>
    </td>
  </tr>
  <tr>
    <td></td>
    <td colspan="2">
      <input name="[% dep.fieldname %]" id="[% dep.fieldname %]"
             value="[% bug.${dep.fieldname}.join(', ') %]" size="45" style="display: none;">
    </td>
  [% ELSE %]
    <td>
      <input type="hidden" id="[% dep.fieldname %]" name="[% dep.fieldname %]"
             value="[% bug.${dep.fieldname}.join(', ') %]">
    </td>
  [% END %]
  [% accesskey = undef %]
[% END %]


[%############################################################################%]
[%# Block for add comment box, group-related settings, and the knob          #%]
[%############################################################################%]

[% BLOCK comment_box %]
  [% IF user.id %]
    <label for="comment" accesskey="c"><b>Additional <u>C</u>omments</b></label>:
    [% IF Param("insidergroup") && user.in_group(Param("insidergroup")) %]
      <input type="checkbox" name="commentprivacy" value="1"
             id="newcommentprivacy"
             onClick="updateCommentTagControl(this, form)">
      <label for="newcommentprivacy">Private</label>
    [% END %]
    <br>
    <a name="add_comment"></a>
    [% INCLUDE global/textarea.html.tmpl
               name      = 'comment'
               id        = 'comment'
               minrows   = 10
               maxrows   = 25
               cols      = constants.COMMENT_COLS
    %]

    [% IF NOT bug.cc || NOT bug.cc.contains(user.login) %]
      [% has_role = bug.user.isreporter
                    || bug.assigned_to.id == user.id
                    || (Param('useqacontact')
                        && bug.qa_contact
                        && bug.qa_contact.id == user.id) %]

      <br>
      <input type="checkbox" id="addselfcc" name="addselfcc"
        [% " checked=\"checked\""
             IF user.settings.state_addselfcc.value == 'always'
                || (!has_role
                    && user.settings.state_addselfcc.value == 'cc_unless_role') %]>
      <label for="addselfcc">Add [% user.identity FILTER html %] to CC list</label>
    [% END %]
  [% ELSE %]
    <fieldset>
      <legend>Note</legend>
      <p>
        You need to
        <a href="show_bug.cgi?id=[% bug.bug_id %]&amp;GoAheadAndLogIn=1">log in</a>
        before you can comment on or make changes to this [% terms.bug %].
      </p>
    </fieldset>
  [% END %]

  <br>

  [% IF bug.groups.size > 0 %]
    [% inallgroups = 1 %]
    [% inagroup = 0 %]
    [% FOREACH group = bug.groups %]
      [% SET inallgroups = 0 IF NOT group.ingroup %]
      [% SET inagroup = 1 IF group.ison %]

      [% IF NOT group.mandatory %]
        [% IF NOT emitted_description %]
          [% emitted_description = 1 %]
          <br>
          <b>Only users in all of the selected groups can view this [% terms.bug %]:</b>
          <br>
          <font size="-1">
            (Unchecking all boxes makes this a more public [% terms.bug %].)
          </font>
          <br>
          <br>
        [% END %]

      &nbsp;&nbsp;&nbsp;&nbsp;
      <input type="checkbox" value="1"
             name="bit-[% group.bit %]" id="bit-[% group.bit %]"
             [% " checked=\"checked\"" IF group.ison %]
             [% " disabled=\"disabled\"" IF NOT group.ingroup %]>
      <label for="bit-[% group.bit %]">[% group.description FILTER html_light %]</label>
      <br>
      [% END %]
    [% END %]

    [% IF NOT inallgroups %]
      <b>
        Only members of a group can change the visibility of [% terms.abug %] for
        that group
      </b>
    <br>
    [% END %]

    [% IF inagroup %]
      <p>
        <b>Users in the roles selected below can always view this [% terms.bug %]:</b>
        <br>
        <small>
          (The assignee
          [% IF (Param('useqacontact')) %]
             and QA contact
          [% END %]
          can always see [% terms.abug %], and this section does not take effect unless
          the [% terms.bug %] is restricted to at least one group.)
        </small>
      </p>

      <p>
        <input type="checkbox" value="1"
               name="reporter_accessible" id="reporter_accessible"
               [% " checked" IF bug.reporter_accessible %]
               [% " disabled=\"disabled\"" UNLESS bug.check_can_change_field("reporter_accessible", 0, 1) %]>
        <label for="reporter_accessible">Reporter</label>
        <input type="checkbox" value="1"
               name="cclist_accessible" id="cclist_accessible"
               [% " checked" IF bug.cclist_accessible %]
               [% " disabled=\"disabled\"" UNLESS bug.check_can_change_field("cclist_accessible", 0, 1) %]>
        <label for="cclist_accessible">CC List</label>
      </p>
    [% END %]
  [% END %]

  [% PROCESS bug/knob.html.tmpl IF user.id %]
[% END %]


[%############################################################################%]
[%# Block for SELECT fields                                                  #%]
[%############################################################################%]

[% BLOCK select %]
  <td colspan="2">
    [% IF bug.check_can_change_field(selname, 0, 1) AND bug.choices.${selname}.size > 1 %]
      <select id="[% selname %]" name="[% selname %]"[% " onChange=\"$onChange\"" IF onChange && bug.isopened %]>
        [% FOREACH x = bug.choices.${selname} %]
          <option value="[% x FILTER html %]"
            [% " selected" IF x == bug.${selname} %]>[% x FILTER html %]
          </option>
        [% END %]
      </select>
    [% ELSE %]
      <input type="hidden" id="[% selname %]" name="[% selname %]" value="[% bug.${selname} FILTER html %]">
      [% bug.${selname} FILTER html %]
    [% END %]
  </td>
  [% onChange = undef %]
[% END %]

[%############################################################################%]
[%# Block for INPUT fields                                                   #%]
[%############################################################################%]

[% BLOCK input %]
  [% UNLESS notable %]
  <td[% " colspan=\"$colspan\"" IF colspan %]>
  [% END %]
    [% val = value ? value : bug.$inputname %]
    [% IF bug.check_can_change_field(inputname, 0, 1) %]
       <input id="[% inputname %]" name="[% inputname %]"
              value="[% val FILTER html %]"[% " size=\"$size\"" IF size %]
              [% " maxlength=\"$maxlength\"" IF maxlength %]
              [% " spellcheck=\"$spellcheck\"" IF spellcheck %]>
    [% ELSE %]
       <input type="hidden" name="[% inputname %]" id="[% inputname %]"
              value="[% val FILTER html %]">
      [% IF size && val.length > size %]
        <span title="[% val FILTER html %]">
          [% val FILTER truncate(size) FILTER html %]
        </span>
      [% ELSE %]
        [% val FILTER html %]
      [% END %]
    [% END %]
  [% "</td>" UNLESS notable %]
  [% maxlength = 0 %]
  [% notable = 0 %]
  [% colspan = 0 %]
  [% size = 0 %]
  [% value = undef %]
  [% spellcheck = undef %]
[% END %]
